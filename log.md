## 2025-09-18 模型评估与数据泄露排查记录

- 结论（初步）：存在强烈的数据泄露迹象。训练集 Accuracy=1.00、AUC≈0.993，且 5 折 CV 方差极小（≈0.0008）。结合用户反馈“测试集已含是否逾期信息”，高度可疑。

- 日志不一致：前置流程提示“数据准备完成: 1000 样本”，但评估阶段打印“已采样 100k 行以优化内存”。需澄清采样与训练/评估所用数据是否来自同一分布与同一行集。

- 已查代码：`evaluation.py` 对以下字段做了潜在泄露清理（若存在则删除）：
  - `payment_ratio`, `paid_principal`, `total_overdue_periods`, `应还本金`, `已还本金`, `剩余本金`, `应还利息`, `已还利息`, `剩余利息`, `还款状态`
  - 若标签列名是 `还款状态`，会被保留为 `label_col`；否则将被当作泄露特征删除。

- 仍需关注的可能泄露通道（未必在清单中）：
  - 任何直接/间接表示是否逾期或还款结果的列，如：`是否逾期`、`逾期天数/期数`、`最后还款日期`、`实际结清日期`、`是否结清`、`已还/剩余`派生比率等。
  - 时间穿越：使用了目标发生后的统计窗口或回溯期（例如用 T+ 的催收/回款产生的字段去预测 T 时点的逾期）。
  - 样本重复/同主体泄露：同一用户/借款在不同切分集合中出现多行（随机切分导致信息泄露）。

### 待办与修复措施（下一步可执行）
1) 扩展泄露特征屏蔽规则（建议基于列名关键词）：
   - 关键词包含：`逾期`、`overdue`、`已还`、`剩余`、`结清`、`应还`、`实还`、`回款`、`repay`、`paid`、`remaining`、`outstanding`、`writeoff`、`chargeoff`、`bad_debt`；凡命中即在训练前删除（除非正被用作标签）。
2) 切分策略：改为按时间切分或 `GroupKFold(user_id/loan_id)`，避免同主体跨集合泄露；严禁随机切分混入同一用户的多期数据。
3) 预处理防泄露：所有编码/标准化/缺失值填充仅在训练集拟合，再应用到验证/测试集。
4) 去重并检查交叉污染：统计 train/val/test 之间的重复率；若重复>0，强制去重或按主体分层切分。
5) 复现实验：多随机种子重复（≥5 次），报告均值±标准差；采用时间切分复评估。
6) 指标扩展与稳健性：补充 PR‑AUC、校准曲线(Brier)、成本敏感阈值选择；绘制学习曲线/验证曲线识别过拟合。

### 快速验证脚本建议
- 在 `evaluation.py` 中：
  - 增加基于关键词的 `leaky_patterns` 过滤；
  - 使用 `GroupKFold` 或按 `放款日期` 做时间切分；
  - 严格将 `fit` 步骤限制在训练集。

### 备注
- `cleaned_LC.csv` 头部字段包含历史还款与逾期统计（例如：`历史逾期还款期数`、`总待还本金` 等），若这些统计是在目标时点之后统计的，须判定时点一致性并可能全部屏蔽/重算为 T 时点可用特征。


## 2025-09-18 执行结果与变更记录

- 已实现（`evaluation.py`）：
  - 新增多语言泄露关键词过滤，自动移除命中列（不含标签）。
  - 切分优先级：时间切分（`借款成功日期` 等）> 分组切分（用户/借款ID）> 分层随机切分；记录所用模式。
  - 使用 `Pipeline`+`ColumnTransformer`，缺失填充/标准化/独热均仅在训练集拟合。
  - `GroupKFold` 或 `StratifiedKFold` 做交叉验证，与切分模式一致。
  - 保留 ROC 曲线与混淆矩阵绘制，输出至 `summaries/`。

- 运行方式：
  - `python evaluation.py`
  - 关注打印的“使用切分方式”“已移除潜在泄露特征: N 列”，以及新的指标与 CV 方差是否显著回落至合理区间。

- 后续验证：
  - 若 AUC/Accuracy 仍异常偏高，请进一步核查未覆盖的泄露字段（如事件时间、结清标识的别名）与同主体跨集合重复。
  - 建议追加 PR-AUC、校准曲线、成本敏感阈值选择到评估报告。


## 2025-09-18 泄露自动化诊断更新

- 新增：极端相关/相等检查与单特征 AUC 扫描（在 `evaluation.py`）。
- 新增：基于分组字段（如 `user_id/借款人ID`）的主体重叠检查，确保训练/测试主体不交叉。
- 产物：诊断报告输出至 `summaries/leakage_report.txt`，包含：
  - 切分模式与使用的时间/分组字段
  - 与标签 |corr|≥0.99 或几乎完全相等的可疑列
  - 单特征即可 AUC≥0.99 的可疑列
- 使用：运行 `python evaluation.py`，同时查看控制台输出与 `summaries/leakage_report.txt`。


## 2025-09-18 开始修复（Clean 构建与复评估）

- 目标：基于“申请时点可得”信息重建干净特征，输出 `engineered_df_clean.csv`，并用新版评估流程验证不再出现异常完美指标。

- 范围：
  - 仅使用 `cleaned_LC.csv` 中申请当时即可观测的字段；暂不合并任何回款/催收/账期结果表。
  - 全面剔除含以下关键词（及英文/别名）的列：`逾期/overdue`、`已还/实还/paid`、`剩余/remaining/outstanding`、`结清/settle`、`应还/应计`、`回款/repay`、`writeoff/chargeoff/bad_debt`、`最后还款日期/实际结清日期` 等。

- 步骤：
  1) 从 `cleaned_LC.csv` 读取数据，保留申请时刻字段，删除所有疑似泄露列并完成必要清洗（缺失填充、类型规范、有限的派生但不触及结果信息）。
  2) 运行 `python feature_engineering_clean.py` 生成 `engineered_df_clean.csv`（UTF-8）。
  3) 运行 `python evaluation.py`（保持现有诊断与时间/分组切分），评估脚本将优先读取 `engineered_df_clean.csv`（若存在）。
  4) 检查 `summaries/leakage_report.txt` 应不再出现极端相关/单特征AUC≈1.0 的列；指标应显著回落并具备合理 CV 方差。

- 验收标准（任一不满足则继续修复）：
  - AUC < 0.95 且 CV Std > 0.002（参考值，视数据量可微调）。
  - 泄露报告中无 `[EQUAL>=0.99]`、`[SINGLE_AUC>=0.99]` 项。
  - 主体重叠检查通过（训练/测试主体无重叠）。

- 后续（如仍异常）：
  - 扩大黑名单词库；
  - 对时间窗口严格对齐（仅用 T 时点之前的统计）；
  - 强制 GroupKFold + 时间切分双重约束。


## 2025-09-18 评估增强与清理

- 评估增强：
  - 新增 PR‑AUC（Average Precision）与 Precision‑Recall 曲线 `summaries/pr_curve.png`。
  - 新增阈值扫描图 `summaries/threshold_curve.png`，报告 Best‑F1 阈值与对应指标。
- 兼容性：`evaluation.py` 优先使用 `engineered_df_clean.csv`，若缺标签会从 `engineered_df.csv` 通过 `ListingId` 合并。
- 清理：废弃早期泄露风险脚本 `feature_engineering.py`（保留 `feature_engineering_clean.py`）。
